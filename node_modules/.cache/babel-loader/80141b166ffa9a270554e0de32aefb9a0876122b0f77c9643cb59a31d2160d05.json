{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport * as log from '../../log';\nimport { uniqueId } from '../../util';\n/**\n * A node in the dataflow tree.\n */\nexport class DataFlowNode {\n  constructor(parent, debugName) {\n    this.debugName = debugName;\n    this._children = [];\n    this._parent = null;\n    if (parent) {\n      this.parent = parent;\n    }\n  }\n  /**\n   * Clone this node with a deep copy but don't clone links to children or parents.\n   */\n  clone() {\n    throw new Error('Cannot clone node');\n  }\n  get parent() {\n    return this._parent;\n  }\n  /**\n   * Set the parent of the node and also add this node to the parent's children.\n   */\n  set parent(parent) {\n    this._parent = parent;\n    if (parent) {\n      parent.addChild(this);\n    }\n  }\n  get children() {\n    return this._children;\n  }\n  numChildren() {\n    return this._children.length;\n  }\n  addChild(child, loc) {\n    // do not add the same child twice\n    if (this._children.includes(child)) {\n      log.warn(log.message.ADD_SAME_CHILD_TWICE);\n      return;\n    }\n    if (loc !== undefined) {\n      this._children.splice(loc, 0, child);\n    } else {\n      this._children.push(child);\n    }\n  }\n  removeChild(oldChild) {\n    const loc = this._children.indexOf(oldChild);\n    this._children.splice(loc, 1);\n    return loc;\n  }\n  /**\n   * Remove node from the dataflow.\n   */\n  remove() {\n    let loc = this._parent.removeChild(this);\n    for (const child of this._children) {\n      // do not use the set method because we want to insert at a particular location\n      child._parent = this._parent;\n      this._parent.addChild(child, loc++);\n    }\n  }\n  /**\n   * Insert another node as a parent of this node.\n   */\n  insertAsParentOf(other) {\n    const parent = other.parent;\n    parent.removeChild(this);\n    this.parent = parent;\n    other.parent = this;\n  }\n  swapWithParent() {\n    const parent = this._parent;\n    const newParent = parent.parent;\n    // reconnect the children\n    for (const child of this._children) {\n      child.parent = parent;\n    }\n    // remove old links\n    this._children = []; // equivalent to removing every child link one by one\n    parent.removeChild(this);\n    const loc = parent.parent.removeChild(parent);\n    // swap two nodes but maintain order in children\n    this._parent = newParent;\n    newParent.addChild(this, loc);\n    parent.parent = this;\n  }\n}\nexport class OutputNode extends DataFlowNode {\n  clone() {\n    const cloneObj = new this.constructor();\n    cloneObj.debugName = `clone_${this.debugName}`;\n    cloneObj._source = this._source;\n    cloneObj._name = `clone_${this._name}`;\n    cloneObj.type = this.type;\n    cloneObj.refCounts = this.refCounts;\n    cloneObj.refCounts[cloneObj._name] = 0;\n    return cloneObj;\n  }\n  /**\n   * @param source The name of the source. Will change in assemble.\n   * @param type The type of the output node.\n   * @param refCounts A global ref counter map.\n   */\n  constructor(parent, source, type, refCounts) {\n    super(parent, source);\n    this.type = type;\n    this.refCounts = refCounts;\n    this._source = this._name = source;\n    if (this.refCounts && !(this._name in this.refCounts)) {\n      this.refCounts[this._name] = 0;\n    }\n  }\n  dependentFields() {\n    return new Set();\n  }\n  producedFields() {\n    return new Set();\n  }\n  hash() {\n    if (this._hash === undefined) {\n      this._hash = `Output ${uniqueId()}`;\n    }\n    return this._hash;\n  }\n  /**\n   * Request the datasource name and increase the ref counter.\n   *\n   * During the parsing phase, this will return the simple name such as 'main' or 'raw'.\n   * It is crucial to request the name from an output node to mark it as a required node.\n   * If nobody ever requests the name, this datasource will not be instantiated in the assemble phase.\n   *\n   * In the assemble phase, this will return the correct name.\n   */\n  getSource() {\n    this.refCounts[this._name]++;\n    return this._source;\n  }\n  isRequired() {\n    return !!this.refCounts[this._name];\n  }\n  setSource(source) {\n    this._source = source;\n  }\n}","map":{"version":3,"mappings":"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","names":["log","uniqueId","DataFlowNode","constructor","parent","debugName","clone","Error","_parent","addChild","children","_children","numChildren","length","child","loc","includes","warn","message","ADD_SAME_CHILD_TWICE","undefined","splice","push","removeChild","oldChild","indexOf","remove","insertAsParentOf","other","swapWithParent","newParent","OutputNode","cloneObj","_source","_name","type","refCounts","source","dependentFields","Set","producedFields","hash","_hash","getSource","isRequired","setSource"],"sourceRoot":"","sources":["../../../../src/compile/data/dataflow.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}